package org.twintail.famidicomputer;

import android.util.Log;
import java.lang.Math;

final class FamidiChannel {
    private static final String TAG = "FamidiChannel";
    private static final int phases = 32;
    private int onNote = -1;
    private int program = 0;
    private int phase = 0;
    private double level = 0.0;
    private double sampleRate = 44100.0;
    private double phaseFrequency = 440.0 * phases;
    private double count = 0.0;
    private double[] velocityToLevel = {
            0.0000000, 0.0000003, 0.0000011, 0.0000026, 0.0000048, 0.0000078, 0.0000117, 0.0000166,
            0.0000229, 0.0000302, 0.0000389, 0.0000490, 0.0000603, 0.0000741, 0.0000891, 0.0001000,
            0.0001288, 0.0001514, 0.0001778, 0.0002042, 0.0002399, 0.0002754, 0.0003162, 0.0003631,
            0.0004074, 0.0004677, 0.0005248, 0.0005888, 0.0006607, 0.0007413, 0.0008318, 0.0009120,
            0.0010233, 0.0011482, 0.0012589, 0.0014125, 0.0015488, 0.0016982, 0.0018621, 0.0020417,
            0.0022909, 0.0025119, 0.0027542, 0.0029512, 0.0032359, 0.0035481, 0.0038905, 0.0042658,
            0.0045709, 0.0050119, 0.0054954, 0.0058884, 0.0064565, 0.0069183, 0.0075858, 0.0081283,
            0.0089125, 0.0095499, 0.0104713, 0.0112202, 0.0120226, 0.0131826, 0.0141254, 0.0151356,
            0.0165959, 0.0177828, 0.0190546, 0.0204174, 0.0218776, 0.0234423, 0.0257040, 0.0275423,
            0.0295121, 0.0316228, 0.0338844, 0.0363078, 0.0389045, 0.0416869, 0.0446684, 0.0478630,
            0.0512861, 0.0549541, 0.0588844, 0.0630957, 0.0676083, 0.0724436, 0.0776247, 0.0812831,
            0.0870964, 0.0933254, 0.1000000, 0.1071519, 0.1148154, 0.1230269, 0.1288250, 0.1380384,
            0.1479108, 0.1584893, 0.1659587, 0.1778279, 0.1905461, 0.2041738, 0.2137962, 0.2290868,
            0.2454709, 0.2630268, 0.2818383, 0.3019952, 0.3162278, 0.3388442, 0.3630781, 0.3801894,
            0.4073803, 0.4365158, 0.4570882, 0.4897788, 0.5248075, 0.5495409, 0.5888437, 0.6309573,
            0.6606934, 0.7079458, 0.7413102, 0.7943282, 0.8511380, 0.8912509, 0.9549926, 1.0000000
    };
    private double[][] waves = {
            {  0.5,  0.5,  0.5,  0.5, -0.5, -0.5, -0.5, -0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5 },  // 12.5%
            {  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5 },  // 25%
            {  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,
               0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5 },  // 50%
            {  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,
               0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,
               0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,  0.5,
              -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5 },  // 75%
            {  0.8,  0.7,  0.6,  0.5,  0.4,  0.3,  0.2,  0.1,
               0.0, -0.1, -0.2, -0.3, -0.4, -0.5, -0.6, -0.7,
              -0.8, -0.7, -0.6, -0.5, -0.4, -0.3, -0.2, -0.1,
               0.0,  0.1,  0.2,  0.3,  0.4,  0.5,  0.6,  0.7 },
    };

    public FamidiChannel(int sampleRate) {
        this.sampleRate = sampleRate;
    }

    public double process() {
        if (onNote < 0)
            return 0.0;

        count += phaseFrequency;
        if (count >= sampleRate) {
            count -= sampleRate;
            phase = (phase + 1) % phases;
        }
        return waves[program][phase] * level;
    }

    public void noteOff(int note) {
        if (onNote == note)
            onNote = -1;
    }

    public void noteOn(int note, int velocity) {
        onNote = note;
        level = velocityToLevel[velocity] * 2.0;
        phaseFrequency = 440.0 * Math.pow(2.0, (note - 69.0) / 12.0) * phases;
    }

    public void programChange(int program) {
        this.program = program % 5;
    }
}
